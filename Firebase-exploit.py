#!/usr/bin/python3
import subprocess
import requests
import json
import os
import sys
import traceback
from shutil import which
from colorama import Fore

url = 'https://www.googleapis.com/identitytoolkit/v3/relyingparty/getProjectConfig?key='
headers = {"content-type": 'application/json'}


# Checking If apktool is installed
def check_apktool():
    try:
        if which("apktool"):
            return True
        else:
            return False
    except Exception as e:
        print(Fore.RED + f"[!] Error in checking apktool: {e}")


# Decompiling the apk
def decompile_apk(apk_file):
    try:
        print(Fore.BLUE + f"[+] Decompiling {os.path.basename(apk_file)}!")
        os.popen(f"apktool d {apk_file}").read()
        print(Fore.BLUE + "[+] Apk decompiled!")
        return apk.split(".")[0]
    except Exception as e:
        print(Fore.RED + f"[!] Error in decompiling apk: {e}")


# Extracting the keys using both regex
def extract_keys(_out_dir):
    try:
        output1 = subprocess.getoutput(f'grep -ProIR "AIzaSy[0-9A-Za-z_-]{{33}}" {_out_dir}')
        output2 = subprocess.getoutput(f'grep -ProIR "AAAA[A-Za-z0-9_-]{{7}}:[A-Za-z0-9_-]{{140}}" {_out_dir}')

        res = []
        if output1:
            res1 = output1.splitlines()
            res.extend(res1)
        if output2:
            res2 = output2.splitlines()
            res.extend(res2)

        if not res:
            print(Fore.RED + "[-] No tokens found")
            exit()

        keys = [i.split(":")[1] for i in res]
        print(Fore.BLUE + f"[+] Found some tokens: {', '.join(list(set(keys)))}")
        return list(set(keys))
    except Exception as e:
        print(Fore.RED + f"[!] Error in extracting keys: {e}")


# Validating the server keys
def validate_keys(key):
    try:
        r = requests.get(url + key)
        if r.status_code == 200:
            response_data = r.json()
            project_id = response_data.get("projectId")
            if project_id:
                return project_id  # Retorna o projectId se encontrado
            else:
                print(Fore.RED + f"[+] {key} is a valid server key, but project id not found in the response")
        else:
            print(Fore.RED + f"[-] {key} is not a valid server key")
    except Exception as e:
        print(Fore.RED + f"[!] Error in validating keys: {e}")

    return None  # Retorna None se a validação falhar


if __name__ == "__main__":
    try:
        if not check_apktool():
            print(Fore.RED + "[!] Install apktool for decompiling the apk!")
            exit()
        apk = sys.argv[1]
        out_dir = decompile_apk(apk)
        server_keys = extract_keys(out_dir)
        if not server_keys:
            print(Fore.RED + "[-] FCM keys not found in extracted apk!")
            exit()

        valid_keys = set()  # Conjunto para rastrear chaves válidas

        for server_key in server_keys:
            if server_key not in valid_keys:
                project_id = validate_keys(server_key)
                if project_id:
                    valid_keys.add(server_key)  # Adiciona a chave válida ao conjunto
                    print(Fore.GREEN + f"[+] ProjectId = {project_id} | Api Key = {server_key} is a valid server key")
                else:
                    valid_keys.add(server_key)  # Adiciona a chave inválida ao conjunto
                    #print(Fore.RED + f"[-] {server_key} is not a valid server key")

        print(Fore.BLUE + f"[+] Finished!")
    except:
        print(traceback.format_exc())
